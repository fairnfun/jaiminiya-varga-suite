<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JaiminÄ«ya Varga Suite Pro</title>
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/tesseract.js@4.0.1/dist/tesseract.min.js"></script>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            serif: ['"Playfair Display"', 'serif'],
            sans: ['Inter', 'sans-serif'],
          },
          colors: {
            vedic: {
              bg: '#F3EEE4',       
              dark: '#2D3243',     
              gold: '#B45309',     
              sacredRed: '#7F1D1D', 
              sacredYellow: '#D97706'
            }
          }
        }
      }
    }
  </script>
  <style>
    @media print { .no-print { display: none !important; } }
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    
    .chart-gradient-border {
      padding: 5px;
      background: linear-gradient(135deg, #7F1D1D 0%, #D97706 50%, #7F1D1D 100%);
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(45, 50, 67, 0.1);
    }

    .loader { border-top-color: #B45309; animation: spinner 1.2s linear infinite; }
    @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-vedic-bg text-vedic-dark font-sans transition-all duration-300">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo } = React;

    // ============================================
    // VERIFIZIERTE LOGIK AUS JAIMINI.HTML
    // ============================================
    const NAVAMSA_1 = [[1,10,7,4,1,10,7,4,1,10,7,4],[2,9,8,3,2,9,8,3,2,9,8,3],[3,8,9,2,3,8,9,2,3,8,9,2],[4,7,10,1,4,7,10,1,4,7,10,1],[5,6,11,12,5,6,11,12,5,6,11,12],[6,5,12,11,6,5,12,11,6,5,12,11],[7,4,1,10,7,4,1,10,7,4,1,10],[8,3,2,9,8,3,2,9,8,3,2,9],[9,2,3,8,9,2,3,8,9,2,3,8]];
    const NAVAMSA_2 = [[1,5,9,1,5,9,1,5,9,1,5,9],[2,6,10,2,6,10,2,6,10,2,6,10],[3,7,11,3,7,11,3,7,11,3,7,11],[4,8,12,4,8,12,4,8,12,4,8,12],[5,9,1,5,9,1,5,9,1,5,9,1],[6,10,2,6,10,2,6,10,2,6,10,2],[7,11,3,7,11,3,7,11,3,7,11,3],[8,12,4,8,12,4,8,12,4,8,12,4],[9,1,5,9,1,5,9,1,5,9,1,5]];
    const DREKKANA_1 = [[1,4,7,10,1,1,7,10,1,1,7,10],[2,5,8,11,2,2,8,11,2,2,8,11],[3,6,9,12,3,3,9,12,3,3,9,12]];
    const DREKKANA_2 = [[1,12,4,9,7,6,10,3,1,12,4,9],[2,11,5,8,8,5,11,2,2,11,5,8],[3,10,6,7,9,4,12,1,3,10,6,7]];

    const GRAHAS = [
      // Erweiterte Regex fÃ¼r den Aszendenten
      { id: 'asc', abbr: 'As', name: 'Ascendant', regex: /Ascendant|Ascendent|Asc|Lagna/i },
      { id: 'sun', abbr: 'Su', name: 'Sun', regex: /Sun/i },
      // Moon Regex bleibt tolerant fÃ¼r o/0
      { id: 'moon', abbr: 'Mo', name: 'Moon', regex: /M[o0][o0]n/i }, 
      { id: 'mars', abbr: 'Ma', name: 'Mars', regex: /Mars/i },
      { id: 'mercury', abbr: 'Me', name: 'Mercury', regex: /Mercury/i },
      { id: 'jupiter', abbr: 'Ju', name: 'Jupiter', regex: /Jupiter/i },
      { id: 'venus', abbr: 'Ve', name: 'Venus', regex: /Venus/i },
      { id: 'saturn', abbr: 'Sa', name: 'Saturn', regex: /Saturn/i },
      { id: 'rahu', abbr: 'Ra', name: 'Rahu', regex: /Rahu/i },
      { id: 'ketu', abbr: 'Ke', name: 'Ketu', regex: /Ketu/i }
    ];

    const toDecimalDegrees = (d, m, s) => parseFloat(d || 0) + parseFloat(m || 0) / 60 + parseFloat(s || 0) / 3600;

    const calculateVargas = (dec) => {
      const norm = ((dec % 360) + 360) % 360;
      const rIdx = Math.floor(norm / 30);
      const pos = norm % 30;
      const nSec = Math.min(Math.floor(pos / (30/9)), 8);
      const dSec = Math.min(Math.floor(pos / 10), 2);
      return { n1: NAVAMSA_1[nSec][rIdx], n2: NAVAMSA_2[nSec][rIdx], d1: DREKKANA_1[dSec][rIdx], d2: DREKKANA_2[dSec][rIdx] };
    };

    const SouthIndianChart = ({ title, subtitle, placements }) => {
      const order = [12, 1, 2, 3, 11, 'center', 4, 10, 'center_h', 5, 9, 8, 7, 6];
      return (
        <div className="chart-gradient-border">
          <div className="grid grid-cols-4 aspect-square bg-vedic-dark gap-[1px] rounded-[3px] overflow-hidden border-[1px] border-vedic-dark">
            {order.map((cell, idx) => {
              if (cell === 'center') {
                return (
                  <div key="center" className="col-span-2 row-span-2 flex flex-col items-center justify-center bg-vedic-bg p-2 border-2 border-vedic-dark">
                    <span className="font-serif text-vedic-gold text-2xl md:text-3xl font-black leading-none mb-1 uppercase tracking-widest">OM</span>
                    <h3 className="font-serif text-vedic-dark font-bold text-[9px] uppercase tracking-wider text-center">{title}</h3>
                    <p className="text-[7px] text-vedic-dark/60 font-sans uppercase italic text-center mt-1 leading-tight">{subtitle}</p>
                  </div>
                );
              }
              if (cell === 'center_h') return null;
              const grahas = placements[cell] || [];
              return (
                <div key={cell} className="aspect-square flex flex-wrap content-center justify-center gap-1 p-1 bg-vedic-bg">
                  {grahas.map(g => (
                    <span key={g} className={`text-[9px] font-bold px-1.5 py-0.5 rounded-sm shadow-sm ${g === 'As' ? 'bg-vedic-dark text-vedic-bg' : 'bg-white border border-vedic-dark/10 text-vedic-dark'}`}>{g}</span>
                  ))}
                </div>
              );
            })}
          </div>
        </div>
      );
    };

    const App = () => {
      const [positions, setPositions] = useState({
        asc: { deg: 0, min: 0, sec: 0 }, sun: { deg: 0, min: 0, sec: 0 }, moon: { deg: 0, min: 0, sec: 0 },
        mars: { deg: 0, min: 0, sec: 0 }, mercury: { deg: 0, min: 0, sec: 0 }, jupiter: { deg: 0, min: 0, sec: 0 },
        venus: { deg: 0, min: 0, sec: 0 }, saturn: { deg: 0, min: 0, sec: 0 }, rahu: { deg: 0, min: 0, sec: 0 }
      });
      const [loading, setLoading] = useState(false);

      const handleInput = (id, unit, val) => {
        setPositions(prev => ({ ...prev, [id]: { ...prev[id], [unit]: parseInt(val) || 0 } }));
      };

      const handleOCR = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        setLoading(true);
        try {
          const { data: { text } } = await Tesseract.recognize(file, 'eng');
          // Bereinigung gÃ¤ngiger OCR-Fehler
          const cleanText = text.replace(/O/g, '0').replace(/[Il|]/g, '1');
          const newP = {
            asc: { deg: 0, min: 0, sec: 0 }, sun: { deg: 0, min: 0, sec: 0 }, moon: { deg: 0, min: 0, sec: 0 },
            mars: { deg: 0, min: 0, sec: 0 }, mercury: { deg: 0, min: 0, sec: 0 }, jupiter: { deg: 0, min: 0, sec: 0 },
            venus: { deg: 0, min: 0, sec: 0 }, saturn: { deg: 0, min: 0, sec: 0 }, rahu: { deg: 0, min: 0, sec: 0 }
          };
          
          GRAHAS.forEach(g => {
            if (g.id === 'ketu') return;
            // Robustere Suche: Name + optionale Zeichen + 3 Zahlengruppen
            const pattern = new RegExp(`(${g.regex.source})[\\s\\W]*(\\d+)[^\\d]+(\\d+)[^\\d]+(\\d+)`, 'i');
            const match = cleanText.match(pattern);
            if (match) {
              newP[g.id] = { deg: parseInt(match[2]), min: parseInt(match[3]), sec: parseInt(match[4]) };
            }
          });
          setPositions(newP);
        } catch (err) { alert("OCR Fehler beim Auslesen."); }
        setLoading(false);
      };

      const vargaResults = useMemo(() => {
        const rDec = toDecimalDegrees(positions.rahu.deg, positions.rahu.min, positions.rahu.sec);
        const kDec = (rDec + 180) % 360;
        const res = {};
        GRAHAS.forEach(g => {
          const dec = g.id === 'ketu' ? kDec : toDecimalDegrees(positions[g.id].deg, positions[g.id].min, positions[g.id].sec);
          res[g.id] = calculateVargas(dec);
        });
        return res;
      }, [positions]);

      const mapPlacements = (key) => {
        const p = {};
        GRAHAS.forEach(g => {
          const rasi = vargaResults[g.id][key];
          if (!p[rasi]) p[rasi] = []; p[rasi].push(g.abbr);
        });
        return p;
      };

      return (
        <div className="max-w-6xl mx-auto px-4 py-12">
          <header className="text-center mb-16 no-print">
            <h1 className="font-serif text-3xl text-vedic-dark font-extrabold tracking-[0.2em] mb-8 uppercase">JaiminÄ«ya Varga Calculator</h1>
            <label className="cursor-pointer bg-vedic-dark text-vedic-bg px-6 py-3 rounded shadow hover:bg-vedic-dark/90 transition-all font-bold text-xs uppercase tracking-widest">
               ðŸ“· Upload Graha Screenshot
               <input type="file" className="hidden" accept="image/*" onChange={handleOCR} disabled={loading} />
            </label>
            {loading && <div className="loader mx-auto mt-6 rounded-full border-4 border-t-4 border-gray-200 h-8 w-8"></div>}
          </header>

          <div className="grid grid-cols-1 lg:grid-cols-12 gap-12">
            <div className="lg:col-span-4 space-y-3 no-print">
              <h2 className="font-serif text-lg font-bold text-vedic-dark mb-4 border-b border-vedic-dark/20 pb-2 uppercase tracking-tight">Positions</h2>
              {GRAHAS.filter(g => g.id !== 'ketu').map(g => (
                <div key={g.id} className="bg-white/60 p-2 rounded flex justify-between items-center border border-vedic-dark/5 shadow-sm">
                  <label className="font-serif text-[10px] font-bold text-vedic-dark uppercase w-20">{g.name}</label>
                  <div className="flex gap-1 flex-1">
                    {['deg','min','sec'].map(u => (
                      <input key={u} type="number" value={positions[g.id][u]} onChange={(e) => handleInput(g.id, u, e.target.value)} className="w-full text-center text-xs bg-transparent border-b border-vedic-dark/20 focus:border-vedic-gold outline-none py-1 font-medium" />
                    ))}
                  </div>
                </div>
              ))}
              <div className="bg-stone-200/50 p-2 rounded flex justify-between items-center border border-vedic-dark/5 italic opacity-60">
                <label className="font-serif text-[10px] font-bold text-vedic-dark uppercase w-20">Ketu</label>
                <div className="flex gap-1 flex-1 text-center text-xs">Auto-calculated (Rahu + 180Â°)</div>
              </div>
            </div>

            <div className="lg:col-span-8 grid grid-cols-1 md:grid-cols-2 gap-10">
              <SouthIndianChart title="NavÄá¹Å›a 1" subtitle="CÄrÄdi Guá¹‡a Navaka" placements={mapPlacements('n1')} />
              <SouthIndianChart title="NavÄá¹Å›a 2" subtitle="TrayÄgni Tattva Navaka" placements={mapPlacements('n2')} />
              <SouthIndianChart title="Drekkaá¹‡a 1" subtitle="Parivá¹›tti-Traya" placements={mapPlacements('d1')} />
              <SouthIndianChart title="Drekkaá¹‡a 2" subtitle="Krama-Vyutkrama" placements={mapPlacements('d2')} />
            </div>
          </div>
          
          <footer className="text-center mt-20 text-vedic-dark/40 font-serif text-xs uppercase tracking-[0.3em] no-print">
            JaiminÄ«ya Varga Suite â€¢ Vedic Excellence
          </footer>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
